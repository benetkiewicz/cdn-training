---
import Layout from "../../layouts/Layout.astro";
import godaddyDnsManagement from "../../../public/lesson3/godaddy-dns-management.png";
import domainManagement from "../../../public/lesson3/domains-management.png";
import domainVerified from "../../../public/lesson3/domain-verified.png";
import dnsDetails from "../../../public/lesson3/dns-details.png";
---

<style>
    .image-wrapper {
        background: #171717;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        margin-bottom: 1rem;
        overflow-x: hidden;
        max-width: 100%;
    }

    /* Lesson specific styles moved from Layout */
    .lesson-content {
        max-width: var(--max-width);
        margin: 0 auto;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--secondary);
        width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        overflow-x: hidden;
        p,
        h2 {
            margin-top: 1rem;
        }

        ul {
            padding-left: 1.5rem;
            margin: 0.75rem 0;
        }

        li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
            position: relative;
        }

        li p {
            margin: 0;
            display: inline;
        }
    }

    .lesson-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--secondary);
    }

    /* Code block styles for lessons */
    pre,
    code {
        max-width: 100%;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
    }
</style>
<Layout>
    <div class="container">
        <div class="lesson-content">
            <h1>Lesson 3: Custom Domain and SSL Setup</h1>

            <p>
                In the previous lesson we configured our Fastly service for basic operations. Part of the initial setup
                was to create a default, free Fastly domain: prefix.global.ssl.fastly.net. This is perfectly fine for
                initial testing but you may need to use your own domain for public or production use. In this lesson we
                will see how to set it up.
            </p>

            <h2>Prerequisites</h2>

            <p>
                Obviously you will need a domain. Each domain registar provides access to a given domain DNS settings.
                Each DNS configuration panel looks slightly different for every domain registrar and also naming of
                things slightly differes, but you should be able to add and edit your domain CNAME records. Explanation
                of how CNAME records work is out of scope of this course. In GoDaddy, which is my domain registar, it
                looks like this:
            </p>
            <div class="image-wrapper">
                <img src={godaddyDnsManagement.src} alt="Godaddy DNS management" />
            </div>
            <p>
                On the Fastly side we need to obtain the TLS certificate for the domain. This will give us the SSL layer
                for our setup and the SNI server name that we want to put in the CNAME record to dispatch traffic to
                Fastly. See step by step instructions below.
            </p>

            <h2>Obtaining the TLS Certificate</h2>
            <p>
                Fastly not only provides a CDN service but also a certificate authority. The certificate management UI
                is located in Security -> TLS Management -> Domains
            </p>
            <div class="image-wrapper">
                <img src={domainManagement.src} alt="Domains management" />
            </div>
            <p>
                But before you can start requesting the certificate, make sure that the domain you request the TLS for
                is already configured in one of your Fastly CDN services. Assuming you want to use the domain
                www.cdn-training.com, you will replace your existing prefix.global.ssl.fastly.net from the previous
                lesson to www.cdn-training.com (or add next to it). Fastly TLS registration process will not allow you
                to advance if none of your services points to the domain you want to set up TLS for. Please also note
                that want to register the domain with the www subdomain.
            </p>
            <h2>Proving Ownership of the Domain</h2>
            <p>
                After filling in the domain name (you can leave the Cerification authority and Select TLS configuration
                fields as default) you click submit and the ownership verification process begins. Fastly needs to
                ensure that the domain belongs to you. To do that, it will require you to create a new CNAME record with
                the given value. In my case, I had to create a new CNAME `_acme-challenge.www` with long cryptic value
                (also called answer in some registars). Fastly will continously check if the record is created. Once it
                can confirm the presence of requested record, you will be presented with the following view:
            </p>
            <div class="image-wrapper">
                <img src={domainVerified.src} alt="Domain verified" />
            </div>
            <h2>Traffic Dispatching Setup</h2>
            <p>
                Issuing of the new certificate will take a few minutes. Once it is ready, you will be able to see click
                it and view/edit it's details. One of the certificate properties will be called CNAME records. This is
                exactly what you need to finish the process on your domain registrar side.
            </p>
            <div class="image-wrapper">
                <img src={dnsDetails.src} alt="DNS details" />
            </div>
            <p>
                Go back to your domain management panel and simlarly to domain ownership verification process, create a
                new CNAME record with the value provided in the CNAME records property of the certificate details.
            </p>

            <p>
                There nothing else to do now but wait. Depending on you domain configuration (and some shere luck) the
                DNS changes will propagate in few minutes up to an hour. You can check monitor the process of the
                propagation by using some networking tools, like dig. Once dig shows the CNAME you just configured,
                you're good to go, and accessing www.youdomain.com should get you to your website through Fastly CDN.
                Congratulations!
            </p>

            <div class="lesson-nav">
                <a href="#" class="button">Previous</a>
                <a href="#" class="button">Next</a>
            </div>
        </div>
    </div>
</Layout>

<!-- Use www. -->

<!-- Before we can do that we need to ensure Fastly that the domain belongs to us. To do that, we need to create a different CNAME record with the answer value equal to the one
Fastly provides us. -->

<!-- You need to create new CNAME record with the name _acme-challenge.www and value as requested by
Fastly -->
